// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NBA Teams with salary cap information
model Team {
  id                 Int     @id @default(autoincrement())
  abbreviation       String
  displayName        String
  shortDisplayName   String
  name               String
  nickname           String
  location           String
  color              String
  alternateColor     String
  slug               String  @unique
  totalCapAllocation Int
  capSpace           Int
  firstApronSpace    Int
  secondApronSpace   Int
  record             Json
  isActive           Boolean @default(true)
  isAllStar          Boolean @default(false)
  logos              Json // Array of logo objects with href, alt, rel, width, height
  links              Json // Array of link objects
  conference         String
  division           String

  // Relations
  players              Player[]
  draftPicks           DraftPick[]
  tradeAssets          TradeAsset[] // Assets this team is trading away
  targetTradeAssets    TradeAsset[]     @relation("TargetTeam") // Assets this team is receiving
  userSelections       UserSelections[] // User selections from this team
  targetUserSelections UserSelections[] @relation("UserSelectionsTargetTeam") // User selections going to this team

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([abbreviation])
  @@index([displayName])
}

// Players on team rosters
model Player {
  id            Int    @id @default(autoincrement())
  espnId        String @unique // ESPN player ID
  firstName     String
  lastName      String
  fullName      String
  displayName   String
  shortName     String
  weight        Int
  displayWeight String
  height        Int
  displayHeight String
  age           Int
  dateOfBirth   String // Changed from DateTime to String to match API format
  birthPlace    Json? // Contains city, state, country
  slug          String
  headshot      Json? // Contains href and alt
  jersey        String
  position      Json // Contains id, name, displayName, abbreviation, leaf
  injuries      Json // Array of injuries
  experience    Json // Contains years
  contract      Json // Contains detailed contract info
  status        Json // Contains id, name, type, abbreviation

  // Team relationship
  teamId Int
  team   Team @relation(fields: [teamId], references: [id])

  // Relations
  tradeAssets    TradeAsset[]
  userSelections UserSelections[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, displayName])
  @@index([teamId])
  @@index([position])
}

// Draft picks (valuable trade assets)
model DraftPick {
  id          Int     @id @default(autoincrement())
  year        Int
  round       Int
  isProtected Boolean @default(false)
  isSwap      Boolean @default(false)
  description String?

  // Relations
  teamId         Int
  team           Team             @relation(fields: [teamId], references: [id])
  tradeAssets    TradeAsset[]
  userSelections UserSelections[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, year, round])
  @@index([teamId])
}

// Generated trades
model Trade {
  id          Int      @id @default(autoincrement())
  userId      String? // Clerk user ID who created this trade (nullable for existing trades)
  rating      Int // 0 - 10 
  title       String // title of trade
  description String? // description or reasoning of trade (optional)
  salaryValid Boolean // if salary matching of trade is valid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assets     TradeAsset[]
  selections UserSelections[]
  votes      TradeVote[]
  comments   TradeComment[]

  @@index([userId])
}

// Reddit-style voting on trades
model TradeVote {
  id        Int      @id @default(autoincrement())
  userId    String // Clerk user ID who voted
  tradeId   Int // Trade being voted on
  value     Int // 1 for upvote, -1 for downvote
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  // Each user can only vote once per trade
  @@unique([userId, tradeId])
  @@index([userId])
  @@index([tradeId])
}

// Comments on trades
model TradeComment {
  id        Int      @id @default(autoincrement())
  userId    String // Clerk user ID who commented
  userName  String // Display name of the user
  content   String // Comment text content
  tradeId   Int // Trade being commented on
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tradeId])
}

// Assets in a trade (players or draft picks)
model TradeAsset {
  id           Int    @id @default(autoincrement())
  type         String // "player" or "pick"
  teamId       Int // Team this asset belongs to
  targetTeamId Int // Team this asset is going to
  tradeId      Int // Trade this asset is part of

  // Relations
  team        Team       @relation(fields: [teamId], references: [id]) // Team this asset is coming from
  targetTeam  Team       @relation("TargetTeam", fields: [targetTeamId], references: [id]) // Team this asset is going to
  playerId    Int? // ID of the player if type is "player"
  player      Player?    @relation(fields: [playerId], references: [id])
  draftPickId Int? // ID of the draft pick if type is "pick"
  draftPick   DraftPick? @relation(fields: [draftPickId], references: [id])
  trade       Trade      @relation(fields: [tradeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([targetTeamId])
  @@index([tradeId])
  @@index([playerId])
  @@index([draftPickId])
}

model UserSelections {
  id           Int    @id @default(autoincrement())
  type         String // "player" or "pick"
  teamId       Int // Team this asset is coming from
  targetTeamId Int // Team this asset is going to
  tradeId      Int // Trade this selection is part of

  // Relations
  team        Team       @relation(fields: [teamId], references: [id]) // Team this asset is coming from
  targetTeam  Team       @relation("UserSelectionsTargetTeam", fields: [targetTeamId], references: [id]) // Team this asset is going to
  playerId    Int? // ID of the player if type is "player"
  player      Player?    @relation(fields: [playerId], references: [id])
  draftPickId Int? // ID of the draft pick if type is "pick"
  draftPick   DraftPick? @relation(fields: [draftPickId], references: [id])
  trade       Trade      @relation(fields: [tradeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([targetTeamId])
  @@index([tradeId])
  @@index([playerId])
  @@index([draftPickId])
}
